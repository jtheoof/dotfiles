#!/bin/bash

GITPATH=$HOME/dev/me/config
FILESPATH=$GITPATH/files
BINPATH=$GITPATH/bin

function install_ppa() {
    read -p "Do you want to install the PPAs? "
    if [ ! $REPLY == 'y' ]; then
        return
    fi
    echo "installing ppas"
    sudo add-apt-repository ppa:tualatrix/ppa # Ubuntu Tweak
    sudo add-apt-repository ppa:tiheum/equinox # Faenza icons
    sudo add-apt-repository ppa:caffeine-developers/ppa # Caffeine

    echo "updating apt repository database"
    sudo apt-get update
}

function install_packages() {
    read -p "Do you want to install useful packages? "
    if [ ! $REPLY == 'y' ]; then
        return
    fi
    # Ubuntu
    sudo apt-get install -y gnome-tweak-tool ubuntu-tweak faenza-icon-theme caffeine synapse
    # Editors
    sudo apt-get install -y vim-gnome exuberant-ctags
    # Shell
    sudo apt-get install -y tree ack-grep zsh terminator tilda
    # Compiz
    sudo apt-get install -y compizconfig-settings-manager compiz-plugins-extra
    # Programming
    sudo apt-get install -y python ruby build-essential ant
    # Graphics
    sudo apt-get install -y gcolor2 colordiff
    # VCS
    sudo apt-get install -y git tig subversion mercurial
    # Networking
    sudo apt-get install -y curl
}

function install_zsh() {
    read -p "Do you want to configure .oh-my-zsh? "
    if [ ! $REPLY == 'y' ]; then
        return
    fi
    olddir=$PWD
    cd $HOME
    echo "fetching oh-my-zsh"
    wget --no-check-certificate https://github.com/robbyrussell/oh-my-zsh/raw/master/tools/install.sh -O - | sh
    for i in $FILESPATH/.config/zsh/themes/*; do
        echo "linking theme: $i"
        ln -is $i $HOME/.oh-my-zsh/themes/$(basename $i)
    done
    read -p "Do you want to switch by default to /bin/zsh? "
    if [ ! $REPLY == 'y' ]; then
        return
    fi
    chsh -s /bin/zsh
}

function config_sudoers() {
    read -p "Do you want to configure /etc/sudoers? "
    if [ ! $REPLY == 'y' ]; then
        return
    fi
    sudo sed -i 's/\(^Defaults\(\s\+\)env_reset\)/\1\nDefaults\2timestamp_timeout=-1/g' /etc/sudoers
}

function config_vim() {
    read -p "Do you want to install vim bundles? "
    if [ ! $REPLY == 'y' ]; then
        return
    fi
    $BINPATH/vim-update-bundles -s
}
    

function create_home_link() {
    filename=$(basename $1)
    echo $1
    echo "linking to: $HOME/$filename"
    if [ -d $HOME/$filename ]; then
        rm -rI $HOME/$filename
    fi
    ln -is $FILESPATH/$filename $HOME/$filename
}

# TODO Factorize link creation to a function
# to handle existing links.
function make_links() {
    read -p "Do you want to create $HOME symlinks? "
    if [ ! $REPLY == 'y' ]; then
        return
    fi
    for i in $FILESPATH/.*rc; do
        echo "linking config file: $i"
        create_home_link $i
    done
    create_home_link $FILESPATH/.dircolors
    create_home_link $FILESPATH/.gitconfig
    create_home_link $FILESPATH/.vim

    # Terminator config
    if [ ! -d $HOME/.config/terminator ]; then
        mkdir -p $HOME/.config/terminator
    elif [ -f $HOME/.config/terminator/config ]; then
        rm $HOME/.config/terminator/config
    fi
    echo "linking local bin"
    ln -is $BINPATH $HOME/.local/bin
    echo "linking terminator config"
    ln -is $FILESPATH/.config/terminator/config $HOME/.config/terminator/config
    if [ ! -d $HOME/.tilda ]; then
        mkdir -p $HOME/.tilda
    fi
    ln -is $FILESPATH/.tilda/config_0 $HOME/.tilda/config_0
}

# FIXME Not working because of a different format
# between terminator color and gnome-terminal color
# gcontool does not understand "#829496"
function config_terminal() {
    read -p "Do you want to configure the terminals? "
    if [ ! $REPLY == 'y' ]; then
        return
    fi
    #terminator_config=$FILESPATH/.config/terminator/config
    #palette=$(ack-grep 'palette\s*=\s*"(.*)"' $terminator_config | \
    #    ack-grep -o '".*"')
    #foreground=$(ack-grep 'foreground_color\s*=\s*"(.*)"' $terminator_config | \
    #    ack-grep -o '".*"')
    #background=$(ack-grep 'background_color\s*=\s*"(.*)"' $terminator_config | \
    #    ack-grep -o '".*"')
    #echo "palette: $palette"
    #echo "foreground: $foreground"
    #echo "background: $background"
    #gconftool-2 --set "/apps/gnome-terminal/profiles/Default/use_theme_background" --type bool false
    #gconftool-2 --set "/apps/gnome-terminal/profiles/Default/use_theme_colors" --type bool false
    #gconftool-2 --set "/apps/gnome-terminal/profiles/Default/palette" --type string $palette
    #gconftool-2 --set "/apps/gnome-terminal/profiles/Default/background_color" --type string $background
    #gconftool-2 --set "/apps/gnome-terminal/profiles/Default/foreground_color" --type string $foreground
    PROFILE=${1:-Default}
    gconftool-2 -s -t string /apps/gnome-terminal/profiles/$PROFILE/palette "#00002B2B3636:#DCDC32322F2F:#858599990000:#B5B589890000:#26268B8BD2D2:#D3D336368282:#2A2AA1A19898:#FDFDF6F6E3E3:#070736364242:#CBCB4B4B1616:#58586E6E7575:#65657B7B8383:#838394949696:#6C6C7171C4C4:#9393A1A1A1A1:#EEEEE8E8D5D5"
    # set highlighted color to be different from foreground-color
    gconftool-2 -s -t bool /apps/gnome-terminal/profiles/$PROFILE/bold_color_same_as_fg false
    # set foreground to base0 and background to base03 and highlight color to base1
    gconftool-2 -s -t string /apps/gnome-terminal/profiles/$PROFILE/background_color "#00002B2B3636"
    gconftool-2 -s -t string /apps/gnome-terminal/profiles/$PROFILE/foreground_color "#838394949696"
    gconftool-2 -s -t string /apps/gnome-terminal/profiles/$PROFILE/bold_color "#9393a1a1a1a1"
    # make sure the profile is set to not use theme colors
    gconftool-2 -s -t bool /apps/gnome-terminal/profiles/$PROFILE/use_theme_colors false
}

install_ppa
install_packages
install_zsh
make_links
config_sudoers
config_vim
config_terminal
